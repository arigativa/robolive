- name: Install Kamailio runtime dependencies [1/2]
  apt:
    pkg:
      - libssl1.1
      - openssl
      - libcurl4
      - libxml2
      - libpcre16-3
      - libpcre32-3
      - libpcrecpp0v5
      - lua5.1
      - luarocks
  tags:
    - signalling
    - kamailio

- name: Install Kamailio runtime dependencies [2/2]
  command: luarocks install lua-cjson
  tags:
    - signalling
    - kamailio

- name: Ensure package directory
  file:
    path: "{{ signalling_package_dir }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  tags:
    - signalling
    - kamailio

- name: Extract Kamailio
  unarchive:
    src: "{{ signalling_kamailio_package }}"
    dest: "{{ signalling_package_dir }}"
    owner: root
    group: root
  notify:
    - Start Kamailio
  tags:
    - signalling
    - kamailio

# Configuration

- name: Ensure configuration directory
  file:
    path: "{{ signalling_conf_dir }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  tags:
    - signalling
    - kamailio

- name: Extract engine scripts
  unarchive:
    src: engine.tar.gz
    dest: "{{ signalling_conf_dir }}"
    owner: root
    group: root
  notify:
   - Start Kamailio
  tags:
    - signalling
    - kamailio

- name: Provide configuration files
  template:
    src: "{{ item }}"
    dest: "{{ signalling_conf_dir }}/{{ item }}"
  with_items:
    - "kamailio.cfg"
    - "tls.cfg"
  tags:
    - signalling
    - kamailio

# Service definition

- name: Copy systemd service file to server
  template:
    src: kamailio.service
    dest: /etc/systemd/system
    owner: root
    group: root
  notify:
    - Start Kamailio
  tags:
    - signalling
    - kamailio
